import{createClient as j}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))l(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const d of s.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&l(d)}).observe(document,{childList:!0,subtree:!0});function o(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function l(t){if(t.ep)return;t.ep=!0;const s=o(t);fetch(t.href,s)}})();const U="https://pkjvdtvomqzcnfhkqven.supabase.co",V="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBranZkdHZvbXF6Y25maGtxdmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NDU2MjYsImV4cCI6MjA4NjMyMTYyNn0.Wn-igVmMwRbmR9ph5uNC4_HdOdclEccqNQWimRP-C38",p=j(U,V);let k=0,u={},f=null,y=[],T=[],A=!0,$=null,P=10,q=[];console.log("ğŸ£ ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•");document.addEventListener("DOMContentLoaded",async function(){const n=new URLSearchParams(window.location.search).get("id");n?await J(n):H()});function H(){document.getElementById("top-page").style.display="flex",document.getElementById("tournament-page").style.display="none",D()}window.enterTournament=function(){const e=document.getElementById("tournament-id-input").value.trim();if(!e){c("å¤§ä¼šIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",!0);return}window.location.href=`?id=${e}`};async function D(){const{data:e,error:n}=await p.from("tournaments").select("id, name, created_at").order("created_at",{ascending:!1}).limit(10),o=document.getElementById("tournament-list");if(n){console.error("å¤§ä¼šä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",n),o.innerHTML='<div style="color: #e74c3c;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';return}if(!e||e.length===0){o.innerHTML='<div style="opacity: 0.6;">ã¾ã å¤§ä¼šãŒã‚ã‚Šã¾ã›ã‚“</div>';return}o.innerHTML=e.map(l=>`
        <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-weight: bold; font-size: 16px;">${l.name}</div>
                <div style="font-size: 12px; opacity: 0.7;">ID: ${l.id}</div>
            </div>
            <button class="btn btn-primary" onclick="window.location.href='?id=${l.id}'" style="padding: 8px 15px; font-size: 14px;">å‚åŠ </button>
        </div>
    `).join("")}window.createTournament=async function(){const e=document.getElementById("new-tournament-id").value.trim(),n=document.getElementById("new-tournament-name").value.trim(),o=document.getElementById("new-tournament-admin-password").value.trim(),l=document.getElementById("new-tournament-staff-password").value.trim();if(!e||!n||!o){c("å¤§ä¼šIDã€å¤§ä¼šåã€ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™",!0);return}if(!/^[a-zA-Z0-9]+$/.test(e)){c("å¤§ä¼šIDã¯åŠè§’è‹±æ•°å­—ã®ã¿ã§å…¥åŠ›ã—ã¦ãã ã•ã„",!0);return}console.log("ğŸ†• å¤§ä¼šä½œæˆ:",{id:e,name:n});const{data:t,error:s}=await p.from("tournaments").insert({id:e,name:n,password:o,staff_password:l||null,rule_type:"limit_total_len",limit_count:0,sort1:"one_max_len",sort2:"one_max_weight",sort3:null}).select();if(s){console.error("å¤§ä¼šä½œæˆã‚¨ãƒ©ãƒ¼:",s),s.code==="23505"?c("ã“ã®å¤§ä¼šIDã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™",!0):c("å¤§ä¼šã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}c("âœ… å¤§ä¼šã‚’ä½œæˆã—ã¾ã—ãŸï¼"),document.getElementById("new-tournament-id").value="",document.getElementById("new-tournament-name").value="",document.getElementById("new-tournament-admin-password").value="",document.getElementById("new-tournament-staff-password").value="",await D(),setTimeout(()=>{window.location.href=`?id=${e}`},1500)};async function J(e){f=e,console.log("ğŸ“‚ å¤§ä¼šID:",f);const{data:n,error:o}=await p.from("tournaments").select("*").eq("id",f).single();if(o||!n){console.error("å¤§ä¼šå–å¾—ã‚¨ãƒ©ãƒ¼:",o),alert("å¤§ä¼šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"),H();return}u=n,console.log("âœ… å¤§ä¼šæƒ…å ±å–å¾—:",u),console.log("ğŸ“‹ å¤§ä¼šãƒ«ãƒ¼ãƒ«:",u.rule_type),console.log("ğŸ“Š ãƒªãƒŸãƒƒãƒˆåŒ¹æ•°:",u.limit_count),console.log("ğŸ¯ å„ªå…ˆé †ä½1:",u.sort1),console.log("ğŸ¯ å„ªå…ˆé †ä½2:",u.sort2),console.log("ğŸ¯ å„ªå…ˆé †ä½3:",u.sort3),document.getElementById("tournament-name").textContent=u.name;const l=u.limit_count>0?`ãƒªãƒŸãƒƒãƒˆ${u.limit_count}åŒ¹`:"ç·åŠ›æˆ¦";document.getElementById("tournament-info").textContent=l,document.getElementById("top-page").style.display="none",document.getElementById("tournament-page").style.display="block",await E(),await _(),G()}function G(){$&&$.unsubscribe(),$=p.channel("tournament-updates").on("postgres_changes",{event:"*",schema:"public",table:"catches",filter:`tournament_id=eq.${f}`},()=>{A&&(console.log("âš¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°"),_(),k>0&&x())}).subscribe(),console.log("ğŸ“¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è³¼èª­é–‹å§‹")}window.toggleRealtimeUpdate=function(){A=document.getElementById("realtime-toggle").checked;const e=document.getElementById("manual-refresh-btn");A?(e.style.display="none",c("âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°: ON"),console.log("ğŸ“¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°: ON")):(e.style.display="inline-block",c("â¸ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°: OFFï¼ˆæ‰‹å‹•æ›´æ–°ãƒ¢ãƒ¼ãƒ‰ï¼‰"),console.log("â¸ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°: OFF"))};window.manualRefreshRanking=async function(){c("ğŸ”„ æ›´æ–°ä¸­..."),await _(),k>0&&await x(),c("âœ… æ›´æ–°ã—ã¾ã—ãŸ")};window.switchTab=function(e){document.querySelectorAll(".tab").forEach((o,l)=>{o.classList.remove("active"),(e==="ranking"&&l===0||e==="input"&&l===1||e==="settings"&&l===2)&&o.classList.add("active")}),document.querySelectorAll(".view").forEach(o=>{o.classList.remove("active")}),e==="ranking"?(document.getElementById("ranking-view").classList.add("active"),_()):e==="input"?(document.getElementById("input-view").classList.add("active"),k>0?(document.getElementById("login-box").style.display="none",document.getElementById("input-form").style.display="block",E(),x()):(document.getElementById("login-box").style.display="block",document.getElementById("input-form").style.display="none")):e==="settings"&&(document.getElementById("settings-view").classList.add("active"),k===2&&(document.getElementById("rule-settings-card").style.display="block",ee()),k>0&&E().then(()=>S()))};window.login=function(){const e=document.getElementById("password-input").value;if(e===u.password)k=2,c("âœ… ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³"),R("ç®¡ç†è€…");else if(e===u.staff_password)k=1,c("âœ… é‹å–¶ã‚¹ã‚¿ãƒƒãƒ•ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³"),R("é‹å–¶ã‚¹ã‚¿ãƒƒãƒ•");else{c("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™",!0);return}console.log("ğŸ” ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ AUTH_LEVEL:",k),document.getElementById("login-box").style.display="none",document.getElementById("input-form").style.display="block",E(),x()};window.logout=function(){te("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ",()=>{k=0,$&&($.unsubscribe(),$=null),c("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"),console.log("ğŸ”“ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ"),window.location.href="/"})};function R(e){const n=document.getElementById("login-status"),o=document.getElementById("login-status-text");o.textContent=`${e}ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ä¸­`,n.style.display="block"}async function E(){console.log("ğŸ‘¥ é¸æ‰‹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹");const{data:e,error:n}=await p.from("players").select("*").eq("tournament_id",f).order("zekken");if(n){console.error("âŒ é¸æ‰‹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",n);return}y=e||[],console.log("âœ… é¸æ‰‹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:",y.length,"äºº"),y.length>0&&console.log("ğŸ“‹ é¸æ‰‹ã‚µãƒ³ãƒ—ãƒ«:",y[0]);const o=document.getElementById("player-select");o.innerHTML='<option value="">é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>',y.forEach(l=>{const t=document.createElement("option");t.value=l.zekken,t.textContent=`${l.zekken}ç•ª: ${l.name}${l.club?` (${l.club})`:""}`,o.appendChild(t)})}function Y(e){return e.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g,function(n){return String.fromCharCode(n.charCodeAt(0)-65248)})}function Z(e){return e.replace(/[\u30A1-\u30F6]/g,function(n){const o=n.charCodeAt(0)-96;return String.fromCharCode(o)})}function K(e){return e.replace(/[\u3041-\u3096]/g,function(n){const o=n.charCodeAt(0)+96;return String.fromCharCode(o)})}function M(e){if(!e)return{original:"",hiragana:"",katakana:"",halfWidth:""};const n=Z(e),o=K(e),l=Y(e);return{original:e,hiragana:n,katakana:o,halfWidth:l}}window.searchPlayer=function(){const e=document.getElementById("player-search"),n=document.getElementById("clear-search-btn"),o=document.getElementById("search-result-count"),l=document.getElementById("player-select"),t=e.value.trim();if(console.log("ğŸ” æ¤œç´¢ã‚¯ã‚¨ãƒª:",t),console.log("ğŸ” é¸æ‰‹ãƒ‡ãƒ¼ã‚¿æ•°:",y.length),y.length>0&&(console.log("ğŸ“‹ é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«ï¼ˆæœ€åˆã®3äººï¼‰:"),y.slice(0,3).forEach(i=>{console.log(`  - ${i.zekken}ç•ª: ${i.name} (${i.club||"æ‰€å±ãªã—"})`)})),n.style.display=t?"block":"none",!t){l.innerHTML='<option value="">é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>',y.forEach(i=>{const r=document.createElement("option");r.value=i.zekken,r.textContent=`${i.zekken}ç•ª: ${i.name}${i.club?` (${i.club})`:""}`,l.appendChild(r)}),o.textContent="";return}const s=M(t);console.log("ğŸ”§ æ­£è¦åŒ–ã•ã‚ŒãŸæ¤œç´¢ã‚¯ã‚¨ãƒª:",{å…ƒ:s.original,ã²ã‚‰ãŒãª:s.hiragana,ã‚«ã‚¿ã‚«ãƒŠ:s.katakana,åŠè§’:s.halfWidth});const d=y.filter(i=>{if(i.zekken.toString()===t||i.zekken.toString()===s.halfWidth)return console.log("âœ… ã‚¼ãƒƒã‚±ãƒ³ä¸€è‡´:",i.zekken),!0;if(i.name){const r=M(i.name);if(i.name.includes(t))return console.log("âœ… åå‰ä¸€è‡´ï¼ˆå®Œå…¨ï¼‰:",i.name,"æ¤œç´¢:",t),!0;if(r.hiragana.includes(s.hiragana)&&s.hiragana!=="")return console.log("âœ… åå‰ä¸€è‡´ï¼ˆã²ã‚‰ãŒãªï¼‰:",i.name,"æ¤œç´¢:",t),!0;if(r.katakana.includes(s.katakana)&&s.katakana!=="")return console.log("âœ… åå‰ä¸€è‡´ï¼ˆã‚«ã‚¿ã‚«ãƒŠï¼‰:",i.name,"æ¤œç´¢:",t),!0;if(r.halfWidth.includes(s.halfWidth)&&s.halfWidth!=="")return console.log("âœ… åå‰ä¸€è‡´ï¼ˆåŠè§’ï¼‰:",i.name,"æ¤œç´¢:",t),!0;const m=i.name.toLowerCase(),g=t.toLowerCase();if(m.includes(g))return console.log("âœ… åå‰ä¸€è‡´ï¼ˆè‹±èªï¼‰:",i.name,"æ¤œç´¢:",t),!0}if(i.club){const r=M(i.club);if(i.club.includes(t))return console.log("âœ… æ‰€å±ä¸€è‡´ï¼ˆå®Œå…¨ï¼‰:",i.club,"æ¤œç´¢:",t),!0;if(r.hiragana.includes(s.hiragana)&&s.hiragana!=="")return console.log("âœ… æ‰€å±ä¸€è‡´ï¼ˆã²ã‚‰ãŒãªï¼‰:",i.club,"æ¤œç´¢:",t),!0;if(r.katakana.includes(s.katakana)&&s.katakana!=="")return console.log("âœ… æ‰€å±ä¸€è‡´ï¼ˆã‚«ã‚¿ã‚«ãƒŠï¼‰:",i.club,"æ¤œç´¢:",t),!0;if(r.halfWidth.includes(s.halfWidth)&&s.halfWidth!=="")return console.log("âœ… æ‰€å±ä¸€è‡´ï¼ˆåŠè§’ï¼‰:",i.club,"æ¤œç´¢:",t),!0;const m=i.club.toLowerCase(),g=t.toLowerCase();if(m.includes(g))return console.log("âœ… æ‰€å±ä¸€è‡´ï¼ˆè‹±èªï¼‰:",i.club,"æ¤œç´¢:",t),!0}return!1});console.log("ğŸ” æ¤œç´¢çµæœ:",d.length,"ä»¶"),l.innerHTML='<option value="">é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>',d.length===0?(o.textContent="è©²å½“ã™ã‚‹é¸æ‰‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“",o.style.color="#ff6b6b"):(d.forEach(i=>{const r=document.createElement("option");r.value=i.zekken,r.textContent=`${i.zekken}ç•ª: ${i.name}${i.club?` (${i.club})`:""}`,l.appendChild(r)}),o.textContent=`${d.length}ä»¶ã®é¸æ‰‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`,o.style.color="#51cf66",d.length===1&&(l.value=d[0].zekken))};window.clearSearch=function(){const e=document.getElementById("player-search"),n=document.getElementById("clear-search-btn"),o=document.getElementById("search-result-count"),l=document.getElementById("player-select");e.value="",n.style.display="none",o.textContent="",l.innerHTML='<option value="">é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>',y.forEach(t=>{const s=document.createElement("option");s.value=t.zekken,s.textContent=`${t.zekken}ç•ª: ${t.name}${t.club?` (${t.club})`:""}`,l.appendChild(s)})};window.registerCatch=async function(){if(k===0){c("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™",!0);return}const e=parseInt(document.getElementById("player-select").value),n=parseFloat(document.getElementById("length-input").value),o=parseFloat(document.getElementById("weight-input").value)||0;if(console.log("ğŸ“ ç™»éŒ²ãƒ‡ãƒ¼ã‚¿:",{zekken:e,length:n,weight:o}),!e){c("é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„",!0);return}if(!n||n<=0){c("é•·å¯¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",!0);return}const l=y.find(d=>d.zekken==e),t=l?l.name:`${e}ç•ª`,{error:s}=await p.from("catches").insert({tournament_id:f,zekken:e,length:n,weight:o});if(s){console.error("âŒ ç™»éŒ²ã‚¨ãƒ©ãƒ¼:",s),c("ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}console.log("âœ… ç™»éŒ²æˆåŠŸ"),c(`âœ… ${t}: ${n}cm ${o>0?o+"g":""} ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼`),document.getElementById("player-select").value="",document.getElementById("length-input").value="",document.getElementById("weight-input").value="",await x(),await _()};async function x(){console.log("ğŸ“‹ å±¥æ­´èª­ã¿è¾¼ã¿é–‹å§‹");const e={};y.forEach(t=>{e[t.zekken]=t.name});const{data:n,error:o}=await p.from("catches").select("*").eq("tournament_id",f).order("created_at",{ascending:!1}).limit(50);if(o){console.error("âŒ å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",o);return}T=n||[],console.log("âœ… å±¥æ­´èª­ã¿è¾¼ã¿å®Œäº†:",T.length,"ä»¶");const l=document.getElementById("history-list");if(T.length===0){l.innerHTML='<div class="empty-state">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';return}l.innerHTML=T.map(t=>{const s=e[t.zekken]||"æœªç™»éŒ²",d=new Date(t.created_at).toLocaleString("ja-JP");return`
            <div class="history-item">
                <div>
                    <strong>${t.zekken}ç•ª: ${s}</strong>
                    <span style="margin-left: 15px; color: #4CAF50;">${t.length}cm</span>
                    ${t.weight>0?`<span style="margin-left: 10px; color: #ccc;">${t.weight}g</span>`:""}
                    <div style="font-size: 12px; color: #aaa; margin-top: 5px;">${d}</div>
                </div>
                ${k===2?`<button class="btn btn-danger" onclick="deleteCatch(${t.id})">å‰Šé™¤</button>`:""}
            </div>
        `}).join("")}window.deleteCatch=async function(e){if(!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))return;const{error:n}=await p.from("catches").delete().eq("id",e);if(n){console.error("âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:",n),c("âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}c("âœ… å‰Šé™¤ã—ã¾ã—ãŸ"),await x(),await _()};async function _(){console.log("ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—é–‹å§‹"),console.log("ğŸ“‹ ç¾åœ¨ã®CONFIG:",u),console.log("ğŸ“Š ãƒªãƒŸãƒƒãƒˆåŒ¹æ•°:",u.limit_count),console.log("ğŸ¯ å¤§ä¼šãƒ«ãƒ¼ãƒ«:",u.rule_type);const{data:e,error:n}=await p.from("catches").select("*").eq("tournament_id",f);if(n){console.error("âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",n);return}const o=e||[];if(console.log("ğŸ“Š é‡£æœãƒ‡ãƒ¼ã‚¿:",o.length,"ä»¶"),o.length===0){document.getElementById("ranking-list").innerHTML='<div class="empty-state">ã¾ã é‡£æœãŒã‚ã‚Šã¾ã›ã‚“</div>',document.getElementById("biggest-fish-list").innerHTML='<div class="empty-state">ã¾ã é‡£æœãŒã‚ã‚Šã¾ã›ã‚“</div>',document.getElementById("smallest-fish-list").innerHTML='<div class="empty-state">ã¾ã é‡£æœãŒã‚ã‚Šã¾ã›ã‚“</div>';return}const l={};y.forEach(a=>{l[a.zekken]=a});const t={};o.forEach(a=>{t[a.zekken]||(t[a.zekken]={zekken:a.zekken,lengths:[],weights:[],min_len:a.length,max_len:a.length,min_weight:a.weight||0,max_weight:a.weight||0}),t[a.zekken].lengths.push(a.length),t[a.zekken].weights.push(a.weight||0),t[a.zekken].min_len=Math.min(t[a.zekken].min_len,a.length),t[a.zekken].max_len=Math.max(t[a.zekken].max_len,a.length),t[a.zekken].min_weight=Math.min(t[a.zekken].min_weight,a.weight||0),t[a.zekken].max_weight=Math.max(t[a.zekken].max_weight,a.weight||0)});const s=Object.values(t).map(a=>{const h=[...a.lengths].sort((v,I)=>I-v),b=[...a.weights].sort((v,I)=>I-v),B=u.limit_count||999;console.log(`ğŸ“Š é¸æ‰‹${a.zekken}ç•ªã®è¨ˆç®—:`,{å…¨é‡£æœæ•°:a.lengths.length,ãƒªãƒŸãƒƒãƒˆåŒ¹æ•°:B,å…¨é•·å¯¸:h,ãƒªãƒŸãƒƒãƒˆé•·å¯¸:h.slice(0,B)});const C=b.slice(0,B).reduce((v,I)=>v+I,0),L=h.slice(0,B).reduce((v,I)=>v+I,0);return{zekken:a.zekken,count:a.lengths.length,max_len:a.max_len,min_len:a.min_len,max_weight:a.max_weight,min_weight:a.min_weight,one_max_len:a.max_len,one_max_weight:a.max_weight,total_weight:a.weights.reduce((v,I)=>v+I,0),total_count:a.lengths.length,limit_weight:C,limit_total_len:L}}),d=u.rule_type||"max_len",i=u.sort1||null,r=u.sort2||null,m=u.sort3||null;s.sort((a,h)=>a[d]!==h[d]?h[d]-a[d]:i&&a[i]!==h[i]?h[i]-a[i]:r&&a[r]!==h[r]?h[r]-a[r]:m&&a[m]!==h[m]?h[m]-a[m]:0),q=s,console.log("âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—å®Œäº†:",s.length,"äºº");const g=document.getElementById("show-biggest-fish")?.checked??!0;g?(document.querySelector(".prize-grid")?.style.setProperty("display","grid"),X(s,l)):document.getElementById("biggest-fish-list").closest(".card").style.display="none";const w=document.getElementById("show-smallest-fish")?.checked??!0;w?(document.querySelector(".prize-grid")?.style.setProperty("display","grid"),Q(s,l)):document.getElementById("smallest-fish-list").closest(".card").style.display="none",!g&&!w&&document.querySelector(".prize-grid")?.style.setProperty("display","none"),W(s,l)}function X(e,n){const o=document.getElementById("biggest-fish-list").closest(".card");o.style.display="block";const l=[...e].sort((i,r)=>r.max_len===i.max_len?r.max_weight-i.max_weight:r.max_len-i.max_len),t=new Set,s=[];for(const i of l)if(!t.has(i.zekken)&&(s.push(i),t.add(i.zekken),s.length===3))break;const d=document.getElementById("biggest-fish-list");d.innerHTML=s.map((i,r)=>{const m=n[i.zekken]||{},g=m.name||"æœªç™»éŒ²",w=m.club||"";return`
            <div class="ranking-item ${r===0?"top3":""}" style="padding: 8px; margin-bottom: 8px;">
                <div class="ranking-header">
                    <div style="font-size: 16px; font-weight: bold;">${r+1}ä½</div>
                    <div>
                        <div style="font-size: 14px; font-weight: bold;">${i.zekken}ç•ª: ${g}</div>
                        ${w?`<div style="font-size: 10px; opacity: 0.8;">${w}</div>`:""}
                    </div>
                </div>
                <div class="ranking-stats">
                    <div class="stat">
                        <div class="stat-label" style="font-size: 10px;">æœ€å¤§é•·å¯¸</div>
                        <div class="stat-value" style="color: #FFD700; font-size: 16px;">${i.max_len.toFixed(1)}cm</div>
                    </div>
                </div>
            </div>
        `}).join("")}function Q(e,n){const o=document.getElementById("smallest-fish-list").closest(".card");o.style.display="block";const l=[...e].sort((i,r)=>i.min_len===r.min_len?i.min_weight-r.min_weight:i.min_len-r.min_len),t=new Set,s=[];for(const i of l)if(!t.has(i.zekken)&&(s.push(i),t.add(i.zekken),s.length===3))break;const d=document.getElementById("smallest-fish-list");d.innerHTML=s.map((i,r)=>{const m=n[i.zekken]||{},g=m.name||"æœªç™»éŒ²",w=m.club||"";return`
            <div class="ranking-item ${r===0?"top3":""}" style="padding: 8px; margin-bottom: 8px;">
                <div class="ranking-header">
                    <div style="font-size: 16px; font-weight: bold;">${r+1}ä½</div>
                    <div>
                        <div style="font-size: 14px; font-weight: bold;">${i.zekken}ç•ª: ${g}</div>
                        ${w?`<div style="font-size: 10px; opacity: 0.8;">${w}</div>`:""}
                    </div>
                </div>
                <div class="ranking-stats">
                    <div class="stat">
                        <div class="stat-label" style="font-size: 10px;">æœ€å°é•·å¯¸</div>
                        <div class="stat-value" style="color: #4CAF50; font-size: 16px;">${i.min_len.toFixed(1)}cm</div>
                    </div>
                </div>
            </div>
        `}).join("")}function W(e,n){const o=u.rule_type||"max_len",l=u.sort1||null,t=u.sort2||null,s=Math.min(P,e.length),d=e.slice(0,s),i=document.getElementById("ranking-list");i.innerHTML=d.map((m,g)=>{const w=g<3,a=n[m.zekken]||{},h=a.name||"æœªç™»éŒ²",b=a.club||"",B=F(o,m[o]),C=l?F(l,m[l]):null,L=t?F(t,m[t]):null;return`
            <div class="ranking-item ${w?"top3":""}">
                <div class="ranking-header">
                    <div style="font-size: 28px; font-weight: bold;">${g+1}ä½</div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold;">${m.zekken}ç•ª: ${h}</div>
                        ${b?`<div style="font-size: 14px; opacity: 0.8;">${b}</div>`:""}
                    </div>
                </div>
                <div class="ranking-stats">
                    <div class="stat">
                        <div class="stat-label">${O[o]}</div>
                        <div class="stat-value" style="color: #FFD700;">${B}</div>
                    </div>
                    ${C?`
                    <div class="stat">
                        <div class="stat-label">${O[l]}</div>
                        <div class="stat-value" style="color: #4CAF50;">${C}</div>
                    </div>
                    `:""}
                    ${L?`
                    <div class="stat">
                        <div class="stat-label">${O[t]}</div>
                        <div class="stat-value" style="color: #2196F3;">${L}</div>
                    </div>
                    `:""}
                </div>
            </div>
        `}).join("");const r=document.getElementById("show-more-btn");e.length>P?r.style.display="block":r.style.display="none"}window.showMoreRankings=function(){P+=10;const e={};y.forEach(n=>{e[n.zekken]=n}),W(q,e),c("10ä»¶è¿½åŠ è¡¨ç¤ºã—ã¾ã—ãŸ")};function F(e,n){return e.includes("len")?`${n.toFixed(1)}cm`:e.includes("weight")?`${Math.round(n)}g`:e==="total_count"?`${n}æš`:n}async function S(){const{data:e,error:n}=await p.from("players").select("*").eq("tournament_id",f).order("zekken");if(n){console.error("é¸æ‰‹ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",n);return}const o=e||[],l=document.getElementById("player-list");if(o.length===0){l.innerHTML='<div class="empty-state">é¸æ‰‹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';return}l.innerHTML=o.map(t=>`
        <div class="player-item">
            <div>
                <strong>${t.zekken}ç•ª:</strong>
                <span style="margin-left: 10px;">${t.name}</span>
                ${t.club?`<span style="color: #aaa; margin-left: 10px;">(${t.club})</span>`:""}
            </div>
            <div>
                <button class="btn btn-primary" style="padding: 8px 15px; font-size: 14px; margin-right: 5px;" onclick="editPlayer(${t.zekken})">ç·¨é›†</button>
                <button class="btn btn-danger" onclick="deletePlayer(${t.zekken})">å‰Šé™¤</button>
            </div>
        </div>
    `).join("")}window.editPlayer=async function(e){const n=y.find(d=>d.zekken===e);if(!n){c("é¸æ‰‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“",!0);return}console.log("ğŸ“ ç·¨é›†å‰ã®é¸æ‰‹æƒ…å ±:",n);const o=prompt(`${e}ç•ªã®æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`,n.name);if(o===null)return;const l=prompt(`${e}ç•ªã®æ–°ã—ã„æ‰€å±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºæ¬„å¯ï¼‰`,n.club||"");if(l===null)return;if(!o.trim()){c("åå‰ã¯å¿…é ˆã§ã™",!0);return}console.log("ğŸ“ æ›´æ–°ãƒ‡ãƒ¼ã‚¿:",{name:o.trim(),club:l.trim()}),console.log("ğŸ“ æ›´æ–°æ¡ä»¶:",{tournament_id:f,zekken:e});const{data:t,error:s}=await p.from("players").update({name:o.trim(),club:l.trim()}).eq("tournament_id",f).eq("zekken",e).select();if(s){console.error("âŒ é¸æ‰‹ç·¨é›†ã‚¨ãƒ©ãƒ¼:",s),console.error("âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°:",JSON.stringify(s,null,2)),c(`âŒ ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${s.message||s.code||"ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}`,!0);return}if(!t||t.length===0){console.error("âŒ æ›´æ–°å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"),c("âŒ æ›´æ–°å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ",!0);return}console.log("âœ… æ›´æ–°å¾Œã®ãƒ‡ãƒ¼ã‚¿:",t),c("âœ… é¸æ‰‹æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ"),await E(),await S(),console.log("âœ… å†èª­ã¿è¾¼ã¿å¾Œã®ALL_PLAYERS:",y.find(d=>d.zekken===e))};window.addPlayer=async function(){if(k!==2){c("ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™",!0);return}const e=parseInt(document.getElementById("new-zekken").value),n=document.getElementById("new-name").value.trim(),o=document.getElementById("new-club").value.trim();if(!e||!n){c("ã‚¼ãƒƒã‚±ãƒ³ç•ªå·ã¨åå‰ã¯å¿…é ˆã§ã™",!0);return}if(y.some(s=>s.zekken===e)){c(`${e}ç•ªã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™`,!0);return}const{error:t}=await p.from("players").insert({tournament_id:f,zekken:e,name:n,club:o||""});if(t){console.error("é¸æ‰‹è¿½åŠ ã‚¨ãƒ©ãƒ¼:",t),c("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé‡è¤‡ã®å¯èƒ½æ€§ï¼‰",!0);return}c("âœ… é¸æ‰‹ã‚’è¿½åŠ ã—ã¾ã—ãŸ"),document.getElementById("new-zekken").value="",document.getElementById("new-name").value="",document.getElementById("new-club").value="",document.getElementById("zekken-warning").style.display="none",document.getElementById("add-player-btn").disabled=!1,await E(),await S()};window.deletePlayer=async function(e){if(!confirm(`${e}ç•ªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;const{error:n}=await p.from("players").delete().eq("tournament_id",f).eq("zekken",e);if(n){console.error("é¸æ‰‹å‰Šé™¤ã‚¨ãƒ©ãƒ¼:",n),c("âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}c("âœ… å‰Šé™¤ã—ã¾ã—ãŸ"),await E(),await S()};const O={limit_total_len:"ãƒªãƒŸãƒƒãƒˆåˆè¨ˆé•·å¯¸",limit_weight:"ãƒªãƒŸãƒƒãƒˆåˆè¨ˆé‡é‡",total_count:"æšæ•°",total_weight:"ç·é‡é‡",one_max_len:"1åŒ¹æœ€å¤§é•·å¯¸",one_max_weight:"1åŒ¹æœ€å¤§é‡é‡"};window.checkZekkenDuplicate=function(e){const n=document.getElementById("zekken-warning"),o=document.getElementById("add-player-btn");if(!e){n.style.display="none",o.disabled=!1;return}const l=parseInt(e);y.some(s=>s.zekken===l)?(n.textContent=`âš ï¸ ${l}ç•ªã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™`,n.style.color="#ff6b6b",n.style.fontWeight="bold",n.style.display="block",o.disabled=!0):(n.textContent=`âœ… ${l}ç•ªã¯åˆ©ç”¨å¯èƒ½ã§ã™`,n.style.color="#4CAF50",n.style.fontWeight="normal",n.style.display="block",o.disabled=!1)};window.updateSortOptions=function(){const e=document.getElementById("rule-type").value,n=document.getElementById("sort1").value,o=document.getElementById("sort2").value,l=[e];n&&l.push(n),o&&l.push(o),N("sort1",l,[e]),N("sort2",l,[e,n]),N("sort3",l,[e,n,o])};function N(e,n,o){const l=document.getElementById(e),t=l.value;l.innerHTML='<option value="">é¸æŠã—ãªã„</option>';const s={one_max_len:"1åŒ¹æœ€å¤§é•·å¯¸",one_max_weight:"1åŒ¹æœ€å¤§é‡é‡",limit_total_len:"ãƒªãƒŸãƒƒãƒˆåˆè¨ˆé•·å¯¸",limit_weight:"ãƒªãƒŸãƒƒãƒˆåˆè¨ˆé‡é‡",total_count:"æšæ•°",total_weight:"ç·é‡é‡"};for(const[d,i]of Object.entries(s))if(!o.includes(d)||d===t){const r=document.createElement("option");r.value=d,r.textContent=i,d===t&&(r.selected=!0),l.appendChild(r)}}async function ee(){if(console.log("âš™ï¸ å¤§ä¼šè¨­å®šèª­ã¿è¾¼ã¿é–‹å§‹"),!u||!u.id){console.error("âŒ CONFIG ãŒå­˜åœ¨ã—ã¾ã›ã‚“");return}document.getElementById("rule-type").value=u.rule_type||"limit_total_len",document.getElementById("limit-count").value=u.limit_count||0;const e=localStorage.getItem(`${f}_show_biggest_fish`),n=localStorage.getItem(`${f}_show_smallest_fish`);document.getElementById("show-biggest-fish").checked=e===null?!0:e==="true",document.getElementById("show-smallest-fish").checked=n===null?!0:n==="true",updateSortOptions(),document.getElementById("sort1").value=u.sort1||"",document.getElementById("sort2").value=u.sort2||"",document.getElementById("sort3").value=u.sort3||"",updateSortOptions(),console.log("âœ… å¤§ä¼šè¨­å®šèª­ã¿è¾¼ã¿å®Œäº†:",u)}window.updateTournamentSettings=async function(){if(k!==2){c("ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™",!0);return}const e=document.getElementById("rule-type").value,n=parseInt(document.getElementById("limit-count").value)||0,o=document.getElementById("sort1").value,l=document.getElementById("sort2").value,t=document.getElementById("sort3").value,s=document.getElementById("show-biggest-fish").checked,d=document.getElementById("show-smallest-fish").checked;localStorage.setItem(`${f}_show_biggest_fish`,s),localStorage.setItem(`${f}_show_smallest_fish`,d);const i=[o,l,t].filter(b=>b!==""),r=new Set(i);if(i.length!==r.size){c("åˆ¤å®šé †ä½ã§åŒã˜é …ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™",!0);return}console.log("ğŸ’¾ è¨­å®šä¿å­˜:",{ruleType:e,limitCount:n,sort1:o,sort2:l,sort3:t,showBiggestFish:s,showSmallestFish:d}),console.log("ğŸ’¾ æ›´æ–°æ¡ä»¶:",{id:f}),console.log("ğŸ’¾ æ›´æ–°å‰ã®CONFIG.limit_count:",u.limit_count);const{data:m,error:g}=await p.from("tournaments").update({rule_type:e,limit_count:n,sort1:o||null,sort2:l||null,sort3:t||null}).eq("id",f).select();if(console.log("ğŸ’¾ UPDATEçµæœ - data:",m),console.log("ğŸ’¾ UPDATEçµæœ - error:",g),g){console.error("âŒ è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:",g),console.error("âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°:",JSON.stringify(g,null,2)),console.error("âŒ ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:",g.code),console.error("âŒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:",g.message),alert(`âŒ è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼: ${g.message}
ã‚³ãƒ¼ãƒ‰: ${g.code}

âš ï¸ Supabase RLS UPDATEæ¨©é™ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
CRITICAL_FIX.sqlã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚`),c(`âŒ è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${g.message||g.code||"ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}`,!0);return}if(!m||m.length===0){console.error("âŒ æ›´æ–°å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"),c("âŒ æ›´æ–°å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ",!0);return}console.log("âœ… æ›´æ–°å¾Œã®ãƒ‡ãƒ¼ã‚¿:",m);const{data:w,error:a}=await p.from("tournaments").select("*").eq("id",f).single();if(a||!w){console.error("âŒ è¨­å®šå†å–å¾—ã‚¨ãƒ©ãƒ¼:",a),c("âŒ è¨­å®šã®å†å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}u=w,console.log("âœ… å†å–å¾—å¾Œã®CONFIG:",u),c("âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");const h=u.limit_count>0?`ãƒªãƒŸãƒƒãƒˆ${u.limit_count}åŒ¹`:"ç·åŠ›æˆ¦";document.getElementById("tournament-info").textContent=h,await _(),console.log("âœ… è¨­å®šä¿å­˜å®Œäº†")};function c(e,n=!1){const o=document.getElementById("toast");o.textContent=e,o.className="toast"+(n?" error":""),o.style.display="block",setTimeout(()=>{o.style.display="none"},3e3)}let z=null;function te(e,n){z=n,document.getElementById("confirm-message").textContent=e;const o=document.getElementById("confirm-dialog");o.style.display="flex"}window.confirmAction=function(){const e=document.getElementById("confirm-dialog");e.style.display="none",z&&(z(),z=null)};window.cancelConfirm=function(){const e=document.getElementById("confirm-dialog");e.style.display="none",z=null};console.log("âœ… ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†");
