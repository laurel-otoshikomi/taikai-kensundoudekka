import{createClient as _}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const l of e)if(l.type==="childList")for(const a of l.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function o(e){const l={};return e.integrity&&(l.integrity=e.integrity),e.referrerPolicy&&(l.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?l.credentials="include":e.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(e){if(e.ep)return;e.ep=!0;const l=o(e);fetch(e.href,l)}})();const z="https://pajzsgbnoqdinvfmvlog.supabase.co",T="sb_publishable_oP9HcAQrGbVNS7dHN4G8UQ_0r5gUTzD",m=_(z,T);let g=0,c={},d=null,f=[],E=[];console.log("ğŸ£ ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•");document.addEventListener("DOMContentLoaded",async function(){const n=new URLSearchParams(window.location.search).get("id");n?await x(n):B()});function B(){document.getElementById("top-page").style.display="flex",document.getElementById("tournament-page").style.display="none"}window.enterTournament=function(){const t=document.getElementById("tournament-id-input").value.trim();if(!t){i("å¤§ä¼šIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",!0);return}window.location.href=`?id=${t}`};async function x(t){d=t,console.log("ğŸ“‚ å¤§ä¼šID:",d);const{data:n,error:o}=await m.from("tournaments").select("*").eq("id",d).single();if(o||!n){console.error("å¤§ä¼šå–å¾—ã‚¨ãƒ©ãƒ¼:",o),alert("å¤§ä¼šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"),B();return}c=n,console.log("âœ… å¤§ä¼šæƒ…å ±å–å¾—:",c),document.getElementById("tournament-name").textContent=c.name;const s=c.limit_count>0?`ãƒªãƒŸãƒƒãƒˆ${c.limit_count}åŒ¹`:"ç·åŠ›æˆ¦";document.getElementById("tournament-info").textContent=`${c.rule_type}ãƒ«ãƒ¼ãƒ« / ${s}`,document.getElementById("top-page").style.display="none",document.getElementById("tournament-page").style.display="block",await w(),P()}function P(){m.channel("tournament-updates").on("postgres_changes",{event:"*",schema:"public",table:"catches",filter:`tournament_id=eq.${d}`},()=>{console.log("âš¡ é‡£æœæ›´æ–°"),w(),g>0&&h()}).subscribe()}window.switchTab=function(t){document.querySelectorAll(".tab").forEach((o,s)=>{o.classList.remove("active"),(t==="ranking"&&s===0||t==="input"&&s===1||t==="settings"&&s===2)&&o.classList.add("active")}),document.querySelectorAll(".view").forEach(o=>{o.classList.remove("active")}),t==="ranking"?(document.getElementById("ranking-view").classList.add("active"),w()):t==="input"?(document.getElementById("input-view").classList.add("active"),g>0?(document.getElementById("login-box").style.display="none",document.getElementById("input-form").style.display="block",v(),h()):(document.getElementById("login-box").style.display="block",document.getElementById("input-form").style.display="none")):t==="settings"&&(document.getElementById("settings-view").classList.add("active"),g===2?(v(),I()):i("ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™",!0))};window.login=function(){const t=document.getElementById("password-input").value;if(t===c.password)g=2,i("âœ… ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³");else if(t===c.staff_password)g=1,i("âœ… é‹å–¶ã‚¹ã‚¿ãƒƒãƒ•ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³");else{i("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™",!0);return}console.log("ğŸ” ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ AUTH_LEVEL:",g),document.getElementById("login-box").style.display="none",document.getElementById("input-form").style.display="block",v(),h()};async function v(){console.log("ğŸ‘¥ é¸æ‰‹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹");const{data:t,error:n}=await m.from("players").select("*").eq("tournament_id",d).order("zekken");if(n){console.error("âŒ é¸æ‰‹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",n);return}f=t||[],console.log("âœ… é¸æ‰‹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:",f.length,"äºº"),f.length>0&&console.log("ğŸ“‹ é¸æ‰‹ã‚µãƒ³ãƒ—ãƒ«:",f[0]);const o=document.getElementById("player-select");o.innerHTML='<option value="">é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>',f.forEach(s=>{const e=document.createElement("option");e.value=s.zekken,e.textContent=`${s.zekken}ç•ª: ${s.name}${s.club?` (${s.club})`:""}`,o.appendChild(e)})}window.registerCatch=async function(){if(g===0){i("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™",!0);return}const t=parseInt(document.getElementById("player-select").value),n=parseFloat(document.getElementById("length-input").value),o=parseFloat(document.getElementById("weight-input").value)||0;if(console.log("ğŸ“ ç™»éŒ²ãƒ‡ãƒ¼ã‚¿:",{zekken:t,length:n,weight:o}),!t){i("é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„",!0);return}if(!n||n<=0){i("é•·å¯¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",!0);return}const s=f.find(k=>k.zekken==t),e=s?s.name:`${t}ç•ª`;if(!confirm(`ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ

${e}
é•·å¯¸: ${n}cm
é‡é‡: ${o}g`))return;const{error:a}=await m.from("catches").insert({tournament_id:d,zekken:t,length:n,weight:o});if(a){console.error("âŒ ç™»éŒ²ã‚¨ãƒ©ãƒ¼:",a),i("ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}console.log("âœ… ç™»éŒ²æˆåŠŸ"),i("âœ… ç™»éŒ²ã—ã¾ã—ãŸï¼"),document.getElementById("player-select").value="",document.getElementById("length-input").value="",document.getElementById("weight-input").value="",await h(),await w()};async function h(){console.log("ğŸ“‹ å±¥æ­´èª­ã¿è¾¼ã¿é–‹å§‹");const t={};f.forEach(e=>{t[e.zekken]=e.name});const{data:n,error:o}=await m.from("catches").select("*").eq("tournament_id",d).order("created_at",{ascending:!1}).limit(50);if(o){console.error("âŒ å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",o);return}E=n||[],console.log("âœ… å±¥æ­´èª­ã¿è¾¼ã¿å®Œäº†:",E.length,"ä»¶");const s=document.getElementById("history-list");if(E.length===0){s.innerHTML='<div class="empty-state">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';return}s.innerHTML=E.map(e=>{const l=t[e.zekken]||"æœªç™»éŒ²",a=new Date(e.created_at).toLocaleString("ja-JP");return`
            <div class="history-item">
                <div>
                    <strong>${e.zekken}ç•ª: ${l}</strong>
                    <span style="margin-left: 15px; color: #4CAF50;">${e.length}cm</span>
                    ${e.weight>0?`<span style="margin-left: 10px; color: #ccc;">${e.weight}g</span>`:""}
                    <div style="font-size: 12px; color: #aaa; margin-top: 5px;">${a}</div>
                </div>
                ${g===2?`<button class="btn btn-danger" onclick="deleteCatch(${e.id})">å‰Šé™¤</button>`:""}
            </div>
        `}).join("")}window.deleteCatch=async function(t){if(!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))return;const{error:n}=await m.from("catches").delete().eq("id",t);if(n){console.error("âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:",n),i("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}i("å‰Šé™¤ã—ã¾ã—ãŸ"),await h(),await w()};async function w(){console.log("ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—é–‹å§‹");const{data:t,error:n}=await m.from("catches").select("*").eq("tournament_id",d);if(n){console.error("âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",n);return}const o=t||[];if(console.log("ğŸ“Š é‡£æœãƒ‡ãƒ¼ã‚¿:",o.length,"ä»¶"),o.length===0){document.getElementById("ranking-list").innerHTML='<div class="empty-state">ã¾ã é‡£æœãŒã‚ã‚Šã¾ã›ã‚“</div>';return}const s={};o.forEach(r=>{s[r.zekken]||(s[r.zekken]={zekken:r.zekken,lengths:[],weights:[]}),s[r.zekken].lengths.push(r.length),s[r.zekken].weights.push(r.weight||0)});const e=Object.values(s).map(r=>{const u=[...r.weights].sort((y,p)=>p-y),b=c.limit_count||999,L=u.slice(0,b).reduce((y,p)=>y+p,0);return{zekken:r.zekken,count:r.lengths.length,max_len:Math.max(...r.lengths),total_weight:r.weights.reduce((y,p)=>y+p,0),limit_weight:L}}),l=c.sort1||"max_len",a=c.sort2||"limit_weight",k=c.sort3||"count";e.sort((r,u)=>r[l]!==u[l]?u[l]-r[l]:r[a]!==u[a]?u[a]-r[a]:u[k]-r[k]),console.log("âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—å®Œäº†:",e.length,"äºº");const $=document.getElementById("ranking-list");$.innerHTML=e.map((r,u)=>`
            <div class="ranking-item ${u<3?"top3":""}">
                <div class="ranking-header">
                    <div style="font-size: 28px; font-weight: bold;">${u+1}ä½</div>
                    <div style="font-size: 24px; font-weight: bold;">${r.zekken}ç•ª</div>
                </div>
                <div class="ranking-stats">
                    <div class="stat">
                        <div class="stat-label">æœ€å¤§</div>
                        <div class="stat-value" style="color: #4CAF50;">${r.max_len}cm</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">åŒ¹æ•°</div>
                        <div class="stat-value" style="color: #2196F3;">${r.count}åŒ¹</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">é‡é‡</div>
                        <div class="stat-value" style="color: #FF9800;">${r.limit_weight}g</div>
                    </div>
                </div>
            </div>
        `).join("")}async function I(){const{data:t,error:n}=await m.from("players").select("*").eq("tournament_id",d).order("zekken");if(n){console.error("é¸æ‰‹ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",n);return}const o=t||[],s=document.getElementById("player-list");if(o.length===0){s.innerHTML='<div class="empty-state">é¸æ‰‹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';return}s.innerHTML=o.map(e=>`
        <div class="player-item">
            <div>
                <strong>${e.zekken}ç•ª:</strong>
                <span style="margin-left: 10px;">${e.name}</span>
                ${e.club?`<span style="color: #aaa; margin-left: 10px;">(${e.club})</span>`:""}
            </div>
            <button class="btn btn-danger" onclick="deletePlayer(${e.zekken})">å‰Šé™¤</button>
        </div>
    `).join("")}window.addPlayer=async function(){if(g!==2){i("ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™",!0);return}const t=parseInt(document.getElementById("new-zekken").value),n=document.getElementById("new-name").value.trim(),o=document.getElementById("new-club").value.trim();if(!t||!n){i("ã‚¼ãƒƒã‚±ãƒ³ç•ªå·ã¨åå‰ã¯å¿…é ˆã§ã™",!0);return}const{error:s}=await m.from("players").insert({tournament_id:d,zekken:t,name:n,club:o||""});if(s){console.error("é¸æ‰‹è¿½åŠ ã‚¨ãƒ©ãƒ¼:",s),i("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé‡è¤‡ã®å¯èƒ½æ€§ï¼‰",!0);return}i("âœ… é¸æ‰‹ã‚’è¿½åŠ ã—ã¾ã—ãŸ"),document.getElementById("new-zekken").value="",document.getElementById("new-name").value="",document.getElementById("new-club").value="",await v(),await I()};window.deletePlayer=async function(t){if(!confirm(`${t}ç•ªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;const{error:n}=await m.from("players").delete().eq("tournament_id",d).eq("zekken",t);if(n){console.error("é¸æ‰‹å‰Šé™¤ã‚¨ãƒ©ãƒ¼:",n),i("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}i("å‰Šé™¤ã—ã¾ã—ãŸ"),await v(),await I()};function i(t,n=!1){const o=document.getElementById("toast");o.textContent=t,o.className="toast"+(n?" error":""),o.style.display="block",setTimeout(()=>{o.style.display="none"},3e3)}console.log("âœ… ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†");
