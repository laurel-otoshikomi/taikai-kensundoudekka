import{createClient as S}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))l(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&l(a)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function l(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}})();const q="https://pkjvdtvomqzcnfhkqven.supabase.co",N="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBranZkdHZvbXF6Y25maGtxdmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NDU2MjYsImV4cCI6MjA4NjMyMTYyNn0.Wn-igVmMwRbmR9ph5uNC4_HdOdclEccqNQWimRP-C38",f=S(q,N);let v=0,r={},g=null,p=[],B=[];console.log("ğŸ£ ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•");document.addEventListener("DOMContentLoaded",async function(){const e=new URLSearchParams(window.location.search).get("id");e?await A(e):P()});function P(){document.getElementById("top-page").style.display="flex",document.getElementById("tournament-page").style.display="none"}window.enterTournament=function(){const t=document.getElementById("tournament-id-input").value.trim();if(!t){c("å¤§ä¼šIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",!0);return}window.location.href=`?id=${t}`};async function A(t){g=t,console.log("ğŸ“‚ å¤§ä¼šID:",g);const{data:e,error:o}=await f.from("tournaments").select("*").eq("id",g).single();if(o||!e){console.error("å¤§ä¼šå–å¾—ã‚¨ãƒ©ãƒ¼:",o),alert("å¤§ä¼šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"),P();return}r=e,console.log("âœ… å¤§ä¼šæƒ…å ±å–å¾—:",r),document.getElementById("tournament-name").textContent=r.name;const l=r.limit_count>0?`ãƒªãƒŸãƒƒãƒˆ${r.limit_count}åŒ¹`:"ç·åŠ›æˆ¦";document.getElementById("tournament-info").textContent=`${r.rule_type}ãƒ«ãƒ¼ãƒ« / ${l}`,document.getElementById("top-page").style.display="none",document.getElementById("tournament-page").style.display="block",await k(),F()}function F(){f.channel("tournament-updates").on("postgres_changes",{event:"*",schema:"public",table:"catches",filter:`tournament_id=eq.${g}`},()=>{console.log("âš¡ é‡£æœæ›´æ–°"),k(),v>0&&_()}).subscribe()}window.switchTab=function(t){document.querySelectorAll(".tab").forEach((o,l)=>{o.classList.remove("active"),(t==="ranking"&&l===0||t==="input"&&l===1||t==="settings"&&l===2)&&o.classList.add("active")}),document.querySelectorAll(".view").forEach(o=>{o.classList.remove("active")}),t==="ranking"?(document.getElementById("ranking-view").classList.add("active"),k()):t==="input"?(document.getElementById("input-view").classList.add("active"),v>0?(document.getElementById("login-box").style.display="none",document.getElementById("input-form").style.display="block",I(),_()):(document.getElementById("login-box").style.display="block",document.getElementById("input-form").style.display="none")):t==="settings"&&(document.getElementById("settings-view").classList.add("active"),v===2&&(document.getElementById("rule-settings-card").style.display="block",H()),v>0&&I().then(()=>x()))};window.login=function(){const t=document.getElementById("password-input").value;if(t===r.password)v=2,c("âœ… ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³");else if(t===r.staff_password)v=1,c("âœ… é‹å–¶ã‚¹ã‚¿ãƒƒãƒ•ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³");else{c("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™",!0);return}console.log("ğŸ” ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ AUTH_LEVEL:",v),document.getElementById("login-box").style.display="none",document.getElementById("input-form").style.display="block",I(),_()};async function I(){console.log("ğŸ‘¥ é¸æ‰‹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹");const{data:t,error:e}=await f.from("players").select("*").eq("tournament_id",g).order("zekken");if(e){console.error("âŒ é¸æ‰‹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",e);return}p=t||[],console.log("âœ… é¸æ‰‹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:",p.length,"äºº"),p.length>0&&console.log("ğŸ“‹ é¸æ‰‹ã‚µãƒ³ãƒ—ãƒ«:",p[0]);const o=document.getElementById("player-select");o.innerHTML='<option value="">é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>',p.forEach(l=>{const n=document.createElement("option");n.value=l.zekken,n.textContent=`${l.zekken}ç•ª: ${l.name}${l.club?` (${l.club})`:""}`,o.appendChild(n)})}window.registerCatch=async function(){if(v===0){c("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™",!0);return}const t=parseInt(document.getElementById("player-select").value),e=parseFloat(document.getElementById("length-input").value),o=parseFloat(document.getElementById("weight-input").value)||0;if(console.log("ğŸ“ ç™»éŒ²ãƒ‡ãƒ¼ã‚¿:",{zekken:t,length:e,weight:o}),!t){c("é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„",!0);return}if(!e||e<=0){c("é•·å¯¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",!0);return}const l=p.find(a=>a.zekken==t),n=l?l.name:`${t}ç•ª`,{error:i}=await f.from("catches").insert({tournament_id:g,zekken:t,length:e,weight:o});if(i){console.error("âŒ ç™»éŒ²ã‚¨ãƒ©ãƒ¼:",i),c("ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}console.log("âœ… ç™»éŒ²æˆåŠŸ"),c(`âœ… ${n}: ${e}cm ${o>0?o+"g":""} ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼`),document.getElementById("player-select").value="",document.getElementById("length-input").value="",document.getElementById("weight-input").value="",await _(),await k()};async function _(){console.log("ğŸ“‹ å±¥æ­´èª­ã¿è¾¼ã¿é–‹å§‹");const t={};p.forEach(n=>{t[n.zekken]=n.name});const{data:e,error:o}=await f.from("catches").select("*").eq("tournament_id",g).order("created_at",{ascending:!1}).limit(50);if(o){console.error("âŒ å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",o);return}B=e||[],console.log("âœ… å±¥æ­´èª­ã¿è¾¼ã¿å®Œäº†:",B.length,"ä»¶");const l=document.getElementById("history-list");if(B.length===0){l.innerHTML='<div class="empty-state">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';return}l.innerHTML=B.map(n=>{const i=t[n.zekken]||"æœªç™»éŒ²",a=new Date(n.created_at).toLocaleString("ja-JP");return`
            <div class="history-item">
                <div>
                    <strong>${n.zekken}ç•ª: ${i}</strong>
                    <span style="margin-left: 15px; color: #4CAF50;">${n.length}cm</span>
                    ${n.weight>0?`<span style="margin-left: 10px; color: #ccc;">${n.weight}g</span>`:""}
                    <div style="font-size: 12px; color: #aaa; margin-top: 5px;">${a}</div>
                </div>
                ${v===2?`<button class="btn btn-danger" onclick="deleteCatch(${n.id})">å‰Šé™¤</button>`:""}
            </div>
        `}).join("")}window.deleteCatch=async function(t){if(!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))return;const{error:e}=await f.from("catches").delete().eq("id",t);if(e){console.error("âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:",e),c("âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}c("âœ… å‰Šé™¤ã—ã¾ã—ãŸ"),await _(),await k()};async function k(){console.log("ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—é–‹å§‹");const{data:t,error:e}=await f.from("catches").select("*").eq("tournament_id",g);if(e){console.error("âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",e);return}const o=t||[];if(console.log("ğŸ“Š é‡£æœãƒ‡ãƒ¼ã‚¿:",o.length,"ä»¶"),o.length===0){document.getElementById("ranking-list").innerHTML='<div class="empty-state">ã¾ã é‡£æœãŒã‚ã‚Šã¾ã›ã‚“</div>';return}const l={};p.forEach(s=>{l[s.zekken]=s});const n={};o.forEach(s=>{n[s.zekken]||(n[s.zekken]={zekken:s.zekken,lengths:[],weights:[]}),n[s.zekken].lengths.push(s.length),n[s.zekken].weights.push(s.weight||0)});const i=Object.values(n).map(s=>{const m=[...s.lengths].sort((h,y)=>y-h),L=[...s.weights].sort((h,y)=>y-h),E=r.limit_count||999,T=L.slice(0,E).reduce((h,y)=>h+y,0),b=m.slice(0,E).reduce((h,y)=>h+y,0);return{zekken:s.zekken,count:s.lengths.length,max_len:Math.max(...s.lengths),max_weight:Math.max(...s.weights),one_max_len:Math.max(...s.lengths),one_max_weight:Math.max(...s.weights),total_weight:s.weights.reduce((h,y)=>h+y,0),total_count:s.lengths.length,limit_weight:T,limit_total_len:b}}),a=r.rule_type||"max_len",d=r.sort1||null,u=r.sort2||null,w=r.sort3||null;i.sort((s,m)=>s[a]!==m[a]?m[a]-s[a]:d&&s[d]!==m[d]?m[d]-s[d]:u&&s[u]!==m[u]?m[u]-s[u]:w&&s[w]!==m[w]?m[w]-s[w]:0),console.log("âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—å®Œäº†:",i.length,"äºº");const z=document.getElementById("ranking-list");z.innerHTML=i.map((s,m)=>{const L=m<3,E=l[s.zekken]||{},T=E.name||"æœªç™»éŒ²",b=E.club||"",h=C(a,s[a]),y=d?C(d,s[d]):null,M=u?C(u,s[u]):null;return`
            <div class="ranking-item ${L?"top3":""}">
                <div class="ranking-header">
                    <div style="font-size: 28px; font-weight: bold;">${m+1}ä½</div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold;">${s.zekken}ç•ª: ${T}</div>
                        ${b?`<div style="font-size: 14px; opacity: 0.8;">${b}</div>`:""}
                    </div>
                </div>
                <div class="ranking-stats">
                    <div class="stat">
                        <div class="stat-label">${$[a]}</div>
                        <div class="stat-value" style="color: #FFD700;">${h}</div>
                    </div>
                    ${y?`
                    <div class="stat">
                        <div class="stat-label">${$[d]}</div>
                        <div class="stat-value" style="color: #4CAF50;">${y}</div>
                    </div>
                    `:""}
                    ${M?`
                    <div class="stat">
                        <div class="stat-label">${$[u]}</div>
                        <div class="stat-value" style="color: #2196F3;">${M}</div>
                    </div>
                    `:""}
                </div>
            </div>
        `}).join("")}function C(t,e){return t.includes("len")?`${e.toFixed(1)}cm`:t.includes("weight")?`${Math.round(e)}g`:t==="total_count"?`${e}æš`:e}async function x(){const{data:t,error:e}=await f.from("players").select("*").eq("tournament_id",g).order("zekken");if(e){console.error("é¸æ‰‹ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",e);return}const o=t||[],l=document.getElementById("player-list");if(o.length===0){l.innerHTML='<div class="empty-state">é¸æ‰‹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';return}l.innerHTML=o.map(n=>`
        <div class="player-item">
            <div>
                <strong>${n.zekken}ç•ª:</strong>
                <span style="margin-left: 10px;">${n.name}</span>
                ${n.club?`<span style="color: #aaa; margin-left: 10px;">(${n.club})</span>`:""}
            </div>
            <div>
                <button class="btn btn-primary" style="padding: 8px 15px; font-size: 14px; margin-right: 5px;" onclick="editPlayer(${n.zekken})">ç·¨é›†</button>
                <button class="btn btn-danger" onclick="deletePlayer(${n.zekken})">å‰Šé™¤</button>
            </div>
        </div>
    `).join("")}window.editPlayer=async function(t){const e=p.find(a=>a.zekken===t);if(!e){c("é¸æ‰‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“",!0);return}console.log("ğŸ“ ç·¨é›†å‰ã®é¸æ‰‹æƒ…å ±:",e);const o=prompt(`${t}ç•ªã®æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`,e.name);if(o===null)return;const l=prompt(`${t}ç•ªã®æ–°ã—ã„æ‰€å±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºæ¬„å¯ï¼‰`,e.club||"");if(l===null)return;if(!o.trim()){c("åå‰ã¯å¿…é ˆã§ã™",!0);return}console.log("ğŸ“ æ›´æ–°ãƒ‡ãƒ¼ã‚¿:",{name:o.trim(),club:l.trim()});const{data:n,error:i}=await f.from("players").update({name:o.trim(),club:l.trim()}).eq("tournament_id",g).eq("zekken",t).select();if(i){console.error("âŒ é¸æ‰‹ç·¨é›†ã‚¨ãƒ©ãƒ¼:",i),c("âŒ ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}console.log("âœ… æ›´æ–°å¾Œã®ãƒ‡ãƒ¼ã‚¿:",n),c("âœ… é¸æ‰‹æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ"),await I(),await x(),console.log("âœ… å†èª­ã¿è¾¼ã¿å¾Œã®ALL_PLAYERS:",p.find(a=>a.zekken===t))};window.addPlayer=async function(){if(v!==2){c("ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™",!0);return}const t=parseInt(document.getElementById("new-zekken").value),e=document.getElementById("new-name").value.trim(),o=document.getElementById("new-club").value.trim();if(!t||!e){c("ã‚¼ãƒƒã‚±ãƒ³ç•ªå·ã¨åå‰ã¯å¿…é ˆã§ã™",!0);return}if(p.some(i=>i.zekken===t)){c(`${t}ç•ªã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™`,!0);return}const{error:n}=await f.from("players").insert({tournament_id:g,zekken:t,name:e,club:o||""});if(n){console.error("é¸æ‰‹è¿½åŠ ã‚¨ãƒ©ãƒ¼:",n),c("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé‡è¤‡ã®å¯èƒ½æ€§ï¼‰",!0);return}c("âœ… é¸æ‰‹ã‚’è¿½åŠ ã—ã¾ã—ãŸ"),document.getElementById("new-zekken").value="",document.getElementById("new-name").value="",document.getElementById("new-club").value="",document.getElementById("zekken-warning").style.display="none",document.getElementById("add-player-btn").disabled=!1,await I(),await x()};window.deletePlayer=async function(t){if(!confirm(`${t}ç•ªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;const{error:e}=await f.from("players").delete().eq("tournament_id",g).eq("zekken",t);if(e){console.error("é¸æ‰‹å‰Šé™¤ã‚¨ãƒ©ãƒ¼:",e),c("âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}c("âœ… å‰Šé™¤ã—ã¾ã—ãŸ"),await I(),await x()};const $={max_len:"é•·å¯¸",max_weight:"é‡é‡",total_count:"æšæ•°",total_weight:"ç·é‡é‡",limit_weight:"ãƒªãƒŸãƒƒãƒˆåˆè¨ˆé‡é‡",one_max_len:"1åŒ¹æœ€å¤§é•·å¯¸",one_max_weight:"1åŒ¹æœ€å¤§é‡é‡",limit_total_len:"ãƒªãƒŸãƒƒãƒˆåˆè¨ˆé•·å¯¸"};window.checkZekkenDuplicate=function(t){const e=document.getElementById("zekken-warning"),o=document.getElementById("add-player-btn");if(!t){e.style.display="none",o.disabled=!1;return}const l=parseInt(t);p.some(i=>i.zekken===l)?(e.textContent=`âš ï¸ ${l}ç•ªã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™`,e.style.color="#ff6b6b",e.style.fontWeight="bold",e.style.display="block",o.disabled=!0):(e.textContent=`âœ… ${l}ç•ªã¯åˆ©ç”¨å¯èƒ½ã§ã™`,e.style.color="#4CAF50",e.style.fontWeight="normal",e.style.display="block",o.disabled=!1)};window.updateSortOptions=function(){const t=document.getElementById("rule-type").value,e=document.getElementById("sort1").value,o=document.getElementById("sort2").value,l=[t];e&&l.push(e),o&&l.push(o),O("sort1",l,[t]),O("sort2",l,[t,e]),O("sort3",l,[t,e,o])};function O(t,e,o){const l=document.getElementById(t),n=l.value;l.innerHTML='<option value="">é¸æŠã—ãªã„</option>';const i={one_max_len:"1åŒ¹æœ€å¤§é•·å¯¸",one_max_weight:"1åŒ¹æœ€å¤§é‡é‡",limit_total_len:"ãƒªãƒŸãƒƒãƒˆåˆè¨ˆé•·å¯¸",limit_weight:"ãƒªãƒŸãƒƒãƒˆåˆè¨ˆé‡é‡",total_count:"æšæ•°åˆè¨ˆ"};for(const[a,d]of Object.entries(i))if(!o.includes(a)||a===n){const u=document.createElement("option");u.value=a,u.textContent=d,a===n&&(u.selected=!0),l.appendChild(u)}}async function H(){if(console.log("âš™ï¸ å¤§ä¼šè¨­å®šèª­ã¿è¾¼ã¿é–‹å§‹"),!r||!r.id){console.error("âŒ CONFIG ãŒå­˜åœ¨ã—ã¾ã›ã‚“");return}document.getElementById("rule-type").value=r.rule_type||r.sort1||"max_len",document.getElementById("limit-count").value=r.limit_count||0,updateSortOptions(),document.getElementById("sort1").value=r.sort1||"",document.getElementById("sort2").value=r.sort2||"",document.getElementById("sort3").value=r.sort3||"",updateSortOptions(),console.log("âœ… å¤§ä¼šè¨­å®šèª­ã¿è¾¼ã¿å®Œäº†:",r)}window.updateTournamentSettings=async function(){if(v!==2){c("ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™",!0);return}const t=document.getElementById("rule-type").value,e=parseInt(document.getElementById("limit-count").value)||0,o=document.getElementById("sort1").value,l=document.getElementById("sort2").value,n=document.getElementById("sort3").value,i=[o,l,n].filter(z=>z!==""),a=new Set(i);if(i.length!==a.size){c("åˆ¤å®šé †ä½ã§åŒã˜é …ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™",!0);return}console.log("ğŸ’¾ è¨­å®šä¿å­˜:",{ruleType:t,limitCount:e,sort1:o,sort2:l,sort3:n});const{error:d}=await f.from("tournaments").update({rule_type:t,limit_count:e,sort1:o||null,sort2:l||null,sort3:n||null}).eq("id",g);if(d){console.error("âŒ è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:",d),c("è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}r.rule_type=t,r.limit_count=e,r.sort1=o||null,r.sort2=l||null,r.sort3=n||null,c("âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");const u=e>0?`ãƒªãƒŸãƒƒãƒˆ${e}åŒ¹`:"ç„¡åˆ¶é™",w=$[t]||t;document.getElementById("tournament-info").textContent=`${w} / ${u}`,await k(),console.log("âœ… è¨­å®šä¿å­˜å®Œäº†")};function c(t,e=!1){const o=document.getElementById("toast");o.textContent=t,o.className="toast"+(e?" error":""),o.style.display="block",setTimeout(()=>{o.style.display="none"},3e3)}console.log("âœ… ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†");
