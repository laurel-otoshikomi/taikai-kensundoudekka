import{createClient as Y}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))l(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&l(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function l(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();const F="https://pkjvdtvomqzcnfhkqven.supabase.co",H="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBranZkdHZvbXF6Y25maGtxdmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NDU2MjYsImV4cCI6MjA4NjMyMTYyNn0.Wn-igVmMwRbmR9ph5uNC4_HdOdclEccqNQWimRP-C38",k=Y(F,H);let w=0,a={},g=null,f=[],C=[];console.log("ğŸ£ ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•");document.addEventListener("DOMContentLoaded",async function(){const e=new URLSearchParams(window.location.search).get("id");e?await R(e):D()});function D(){document.getElementById("top-page").style.display="flex",document.getElementById("tournament-page").style.display="none"}window.enterTournament=function(){const t=document.getElementById("tournament-id-input").value.trim();if(!t){c("å¤§ä¼šIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",!0);return}window.location.href=`?id=${t}`};async function R(t){g=t,console.log("ğŸ“‚ å¤§ä¼šID:",g);const{data:e,error:n}=await k.from("tournaments").select("*").eq("id",g).single();if(n||!e){console.error("å¤§ä¼šå–å¾—ã‚¨ãƒ©ãƒ¼:",n),alert("å¤§ä¼šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"),D();return}a=e,console.log("âœ… å¤§ä¼šæƒ…å ±å–å¾—:",a),console.log("ğŸ“‹ å¤§ä¼šãƒ«ãƒ¼ãƒ«:",a.rule_type),console.log("ğŸ“Š ãƒªãƒŸãƒƒãƒˆåŒ¹æ•°:",a.limit_count),console.log("ğŸ¯ å„ªå…ˆé †ä½1:",a.sort1),console.log("ğŸ¯ å„ªå…ˆé †ä½2:",a.sort2),console.log("ğŸ¯ å„ªå…ˆé †ä½3:",a.sort3),document.getElementById("tournament-name").textContent=a.name;const l=a.limit_count>0?`ãƒªãƒŸãƒƒãƒˆ${a.limit_count}åŒ¹`:"ç·åŠ›æˆ¦";document.getElementById("tournament-info").textContent=`${a.rule_type}ãƒ«ãƒ¼ãƒ« / ${l}`,document.getElementById("top-page").style.display="none",document.getElementById("tournament-page").style.display="block",await L(),await $(),j()}function j(){k.channel("tournament-updates").on("postgres_changes",{event:"*",schema:"public",table:"catches",filter:`tournament_id=eq.${g}`},()=>{console.log("âš¡ é‡£æœæ›´æ–°"),$(),w>0&&z()}).subscribe()}window.switchTab=function(t){document.querySelectorAll(".tab").forEach((n,l)=>{n.classList.remove("active"),(t==="ranking"&&l===0||t==="input"&&l===1||t==="settings"&&l===2)&&n.classList.add("active")}),document.querySelectorAll(".view").forEach(n=>{n.classList.remove("active")}),t==="ranking"?(document.getElementById("ranking-view").classList.add("active"),$()):t==="input"?(document.getElementById("input-view").classList.add("active"),w>0?(document.getElementById("login-box").style.display="none",document.getElementById("input-form").style.display="block",L(),z()):(document.getElementById("login-box").style.display="block",document.getElementById("input-form").style.display="none")):t==="settings"&&(document.getElementById("settings-view").classList.add("active"),w===2&&(document.getElementById("rule-settings-card").style.display="block",U()),w>0&&L().then(()=>S()))};window.login=function(){const t=document.getElementById("password-input").value;if(t===a.password)w=2,c("âœ… ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³");else if(t===a.staff_password)w=1,c("âœ… é‹å–¶ã‚¹ã‚¿ãƒƒãƒ•ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³");else{c("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™",!0);return}console.log("ğŸ” ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ AUTH_LEVEL:",w),document.getElementById("login-box").style.display="none",document.getElementById("input-form").style.display="block",L(),z()};async function L(){console.log("ğŸ‘¥ é¸æ‰‹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹");const{data:t,error:e}=await k.from("players").select("*").eq("tournament_id",g).order("zekken");if(e){console.error("âŒ é¸æ‰‹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",e);return}f=t||[],console.log("âœ… é¸æ‰‹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:",f.length,"äºº"),f.length>0&&console.log("ğŸ“‹ é¸æ‰‹ã‚µãƒ³ãƒ—ãƒ«:",f[0]);const n=document.getElementById("player-select");n.innerHTML='<option value="">é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>',f.forEach(l=>{const o=document.createElement("option");o.value=l.zekken,o.textContent=`${l.zekken}ç•ª: ${l.name}${l.club?` (${l.club})`:""}`,n.appendChild(o)})}window.registerCatch=async function(){if(w===0){c("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™",!0);return}const t=_,e=parseFloat(document.getElementById("length-input").value),n=parseFloat(document.getElementById("weight-input").value)||0;if(console.log("ğŸ“ ç™»éŒ²ãƒ‡ãƒ¼ã‚¿:",{zekken:t,length:e,weight:n}),!t){c("é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„",!0);return}if(!e||e<=0){c("é•·å¯¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",!0);return}const l=f.find(r=>r.zekken==t),o=l?l.name:`${t}ç•ª`,{error:s}=await k.from("catches").insert({tournament_id:g,zekken:t,length:e,weight:n});if(s){console.error("âŒ ç™»éŒ²ã‚¨ãƒ©ãƒ¼:",s),c("ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}console.log("âœ… ç™»éŒ²æˆåŠŸ"),c(`âœ… ${o}: ${e}cm ${n>0?n+"g":""} ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼`),_=null,document.getElementById("selected-player-display").style.display="none",document.getElementById("player-select-btn").textContent="é¸æ‰‹ã‚’é¸æŠ",document.getElementById("length-input").value="",document.getElementById("weight-input").value="",await z(),await $()};async function z(){console.log("ğŸ“‹ å±¥æ­´èª­ã¿è¾¼ã¿é–‹å§‹");const t={};f.forEach(o=>{t[o.zekken]=o.name});const{data:e,error:n}=await k.from("catches").select("*").eq("tournament_id",g).order("created_at",{ascending:!1}).limit(50);if(n){console.error("âŒ å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",n);return}C=e||[],console.log("âœ… å±¥æ­´èª­ã¿è¾¼ã¿å®Œäº†:",C.length,"ä»¶");const l=document.getElementById("history-list");if(C.length===0){l.innerHTML='<div class="empty-state">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';return}l.innerHTML=C.map(o=>{const s=t[o.zekken]||"æœªç™»éŒ²",r=new Date(o.created_at).toLocaleString("ja-JP");return`
            <div class="history-item">
                <div>
                    <strong>${o.zekken}ç•ª: ${s}</strong>
                    <span style="margin-left: 15px; color: #4CAF50;">${o.length}cm</span>
                    ${o.weight>0?`<span style="margin-left: 10px; color: #ccc;">${o.weight}g</span>`:""}
                    <div style="font-size: 12px; color: #aaa; margin-top: 5px;">${r}</div>
                </div>
                ${w===2?`<button class="btn btn-danger" onclick="deleteCatch(${o.id})">å‰Šé™¤</button>`:""}
            </div>
        `}).join("")}window.deleteCatch=async function(t){if(!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))return;const{error:e}=await k.from("catches").delete().eq("id",t);if(e){console.error("âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:",e),c("âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}c("âœ… å‰Šé™¤ã—ã¾ã—ãŸ"),await z(),await $()};async function $(){console.log("ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—é–‹å§‹"),console.log("ğŸ“‹ ç¾åœ¨ã®CONFIG:",a),console.log("ğŸ“Š ãƒªãƒŸãƒƒãƒˆåŒ¹æ•°:",a.limit_count),console.log("ğŸ¯ å¤§ä¼šãƒ«ãƒ¼ãƒ«:",a.rule_type);const{data:t,error:e}=await k.from("catches").select("*").eq("tournament_id",g);if(e){console.error("âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",e);return}const n=t||[];if(console.log("ğŸ“Š é‡£æœãƒ‡ãƒ¼ã‚¿:",n.length,"ä»¶"),n.length===0){document.getElementById("ranking-list").innerHTML='<div class="empty-state">ã¾ã é‡£æœãŒã‚ã‚Šã¾ã›ã‚“</div>';return}const l={};f.forEach(i=>{l[i.zekken]=i});const o={};n.forEach(i=>{o[i.zekken]||(o[i.zekken]={zekken:i.zekken,lengths:[],weights:[]}),o[i.zekken].lengths.push(i.length),o[i.zekken].weights.push(i.weight||0)});const s=Object.values(o).map(i=>{const m=[...i.lengths].sort((p,v)=>v-p),I=[...i.weights].sort((p,v)=>v-p),y=a.limit_count||999;console.log(`ğŸ“Š é¸æ‰‹${i.zekken}ç•ªã®è¨ˆç®—:`,{å…¨é‡£æœæ•°:i.lengths.length,ãƒªãƒŸãƒƒãƒˆåŒ¹æ•°:y,å…¨é•·å¯¸:m,ãƒªãƒŸãƒƒãƒˆé•·å¯¸:m.slice(0,y)});const h=I.slice(0,y).reduce((p,v)=>p+v,0),B=m.slice(0,y).reduce((p,v)=>p+v,0);return{zekken:i.zekken,count:i.lengths.length,max_len:Math.max(...i.lengths),max_weight:Math.max(...i.weights),one_max_len:Math.max(...i.lengths),one_max_weight:Math.max(...i.weights),total_weight:i.weights.reduce((p,v)=>p+v,0),total_count:i.lengths.length,limit_weight:h,limit_total_len:B}}),r=a.rule_type||"max_len",d=a.sort1||null,u=a.sort2||null,b=a.sort3||null;s.sort((i,m)=>i[r]!==m[r]?m[r]-i[r]:d&&i[d]!==m[d]?m[d]-i[d]:u&&i[u]!==m[u]?m[u]-i[u]:b&&i[b]!==m[b]?m[b]-i[b]:0),console.log("âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—å®Œäº†:",s.length,"äºº");const E=document.getElementById("ranking-list");E.innerHTML=s.map((i,m)=>{const I=m<3,y=l[i.zekken]||{},h=y.name||"æœªç™»éŒ²",B=y.club||"",p=P(r,i[r]),v=d?P(d,i[d]):null,q=u?P(u,i[u]):null;return`
            <div class="ranking-item ${I?"top3":""}">
                <div class="ranking-header">
                    <div style="font-size: 28px; font-weight: bold;">${m+1}ä½</div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold;">${i.zekken}ç•ª: ${h}</div>
                        ${B?`<div style="font-size: 14px; opacity: 0.8;">${B}</div>`:""}
                    </div>
                </div>
                <div class="ranking-stats">
                    <div class="stat">
                        <div class="stat-label">${T[r]}</div>
                        <div class="stat-value" style="color: #FFD700;">${p}</div>
                    </div>
                    ${v?`
                    <div class="stat">
                        <div class="stat-label">${T[d]}</div>
                        <div class="stat-value" style="color: #4CAF50;">${v}</div>
                    </div>
                    `:""}
                    ${q?`
                    <div class="stat">
                        <div class="stat-label">${T[u]}</div>
                        <div class="stat-value" style="color: #2196F3;">${q}</div>
                    </div>
                    `:""}
                </div>
            </div>
        `}).join("")}function P(t,e){return t.includes("len")?`${e.toFixed(1)}cm`:t.includes("weight")?`${Math.round(e)}g`:t==="total_count"?`${e}æš`:e}async function S(){const{data:t,error:e}=await k.from("players").select("*").eq("tournament_id",g).order("zekken");if(e){console.error("é¸æ‰‹ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",e);return}const n=t||[],l=document.getElementById("player-list");if(n.length===0){l.innerHTML='<div class="empty-state">é¸æ‰‹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';return}l.innerHTML=n.map(o=>`
        <div class="player-item">
            <div>
                <strong>${o.zekken}ç•ª:</strong>
                <span style="margin-left: 10px;">${o.name}</span>
                ${o.club?`<span style="color: #aaa; margin-left: 10px;">(${o.club})</span>`:""}
            </div>
            <div>
                <button class="btn btn-primary" style="padding: 8px 15px; font-size: 14px; margin-right: 5px;" onclick="editPlayer(${o.zekken})">ç·¨é›†</button>
                <button class="btn btn-danger" onclick="deletePlayer(${o.zekken})">å‰Šé™¤</button>
            </div>
        </div>
    `).join("")}window.editPlayer=async function(t){const e=f.find(r=>r.zekken===t);if(!e){c("é¸æ‰‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“",!0);return}console.log("ğŸ“ ç·¨é›†å‰ã®é¸æ‰‹æƒ…å ±:",e);const n=prompt(`${t}ç•ªã®æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`,e.name);if(n===null)return;const l=prompt(`${t}ç•ªã®æ–°ã—ã„æ‰€å±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºæ¬„å¯ï¼‰`,e.club||"");if(l===null)return;if(!n.trim()){c("åå‰ã¯å¿…é ˆã§ã™",!0);return}console.log("ğŸ“ æ›´æ–°ãƒ‡ãƒ¼ã‚¿:",{name:n.trim(),club:l.trim()}),console.log("ğŸ“ æ›´æ–°æ¡ä»¶:",{tournament_id:g,zekken:t});const{data:o,error:s}=await k.from("players").update({name:n.trim(),club:l.trim()}).eq("tournament_id",g).eq("zekken",t).select();if(s){console.error("âŒ é¸æ‰‹ç·¨é›†ã‚¨ãƒ©ãƒ¼:",s),console.error("âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°:",JSON.stringify(s,null,2)),c(`âŒ ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${s.message||s.code||"ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}`,!0);return}if(!o||o.length===0){console.error("âŒ æ›´æ–°å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"),c("âŒ æ›´æ–°å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ",!0);return}console.log("âœ… æ›´æ–°å¾Œã®ãƒ‡ãƒ¼ã‚¿:",o),c("âœ… é¸æ‰‹æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ"),await L(),await S(),console.log("âœ… å†èª­ã¿è¾¼ã¿å¾Œã®ALL_PLAYERS:",f.find(r=>r.zekken===t))};window.addPlayer=async function(){if(w!==2){c("ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™",!0);return}const t=parseInt(document.getElementById("new-zekken").value),e=document.getElementById("new-name").value.trim(),n=document.getElementById("new-club").value.trim();if(!t||!e){c("ã‚¼ãƒƒã‚±ãƒ³ç•ªå·ã¨åå‰ã¯å¿…é ˆã§ã™",!0);return}if(f.some(s=>s.zekken===t)){c(`${t}ç•ªã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™`,!0);return}const{error:o}=await k.from("players").insert({tournament_id:g,zekken:t,name:e,club:n||""});if(o){console.error("é¸æ‰‹è¿½åŠ ã‚¨ãƒ©ãƒ¼:",o),c("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé‡è¤‡ã®å¯èƒ½æ€§ï¼‰",!0);return}c("âœ… é¸æ‰‹ã‚’è¿½åŠ ã—ã¾ã—ãŸ"),document.getElementById("new-zekken").value="",document.getElementById("new-name").value="",document.getElementById("new-club").value="",document.getElementById("zekken-warning").style.display="none",document.getElementById("add-player-btn").disabled=!1,await L(),await S()};window.deletePlayer=async function(t){if(!confirm(`${t}ç•ªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;const{error:e}=await k.from("players").delete().eq("tournament_id",g).eq("zekken",t);if(e){console.error("é¸æ‰‹å‰Šé™¤ã‚¨ãƒ©ãƒ¼:",e),c("âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}c("âœ… å‰Šé™¤ã—ã¾ã—ãŸ"),await L(),await S()};const T={limit_total_len:"ãƒªãƒŸãƒƒãƒˆåˆè¨ˆé•·å¯¸",limit_weight:"ãƒªãƒŸãƒƒãƒˆåˆè¨ˆé‡é‡",total_count:"æšæ•°",total_weight:"ç·é‡é‡",one_max_len:"1åŒ¹æœ€å¤§é•·å¯¸",one_max_weight:"1åŒ¹æœ€å¤§é‡é‡"};window.checkZekkenDuplicate=function(t){const e=document.getElementById("zekken-warning"),n=document.getElementById("add-player-btn");if(!t){e.style.display="none",n.disabled=!1;return}const l=parseInt(t);f.some(s=>s.zekken===l)?(e.textContent=`âš ï¸ ${l}ç•ªã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™`,e.style.color="#ff6b6b",e.style.fontWeight="bold",e.style.display="block",n.disabled=!0):(e.textContent=`âœ… ${l}ç•ªã¯åˆ©ç”¨å¯èƒ½ã§ã™`,e.style.color="#4CAF50",e.style.fontWeight="normal",e.style.display="block",n.disabled=!1)};window.updateSortOptions=function(){const t=document.getElementById("rule-type").value,e=document.getElementById("sort1").value,n=document.getElementById("sort2").value,l=[t];e&&l.push(e),n&&l.push(n),M("sort1",l,[t]),M("sort2",l,[t,e]),M("sort3",l,[t,e,n])};function M(t,e,n){const l=document.getElementById(t),o=l.value;l.innerHTML='<option value="">é¸æŠã—ãªã„</option>';const s={one_max_len:"1åŒ¹æœ€å¤§é•·å¯¸",one_max_weight:"1åŒ¹æœ€å¤§é‡é‡",limit_total_len:"ãƒªãƒŸãƒƒãƒˆåˆè¨ˆé•·å¯¸",limit_weight:"ãƒªãƒŸãƒƒãƒˆåˆè¨ˆé‡é‡",total_count:"æšæ•°",total_weight:"ç·é‡é‡"};for(const[r,d]of Object.entries(s))if(!n.includes(r)||r===o){const u=document.createElement("option");u.value=r,u.textContent=d,r===o&&(u.selected=!0),l.appendChild(u)}}async function U(){if(console.log("âš™ï¸ å¤§ä¼šè¨­å®šèª­ã¿è¾¼ã¿é–‹å§‹"),!a||!a.id){console.error("âŒ CONFIG ãŒå­˜åœ¨ã—ã¾ã›ã‚“");return}document.getElementById("rule-type").value=a.rule_type||"limit_total_len",x=a.limit_count||0;const e=[{value:0,label:"ç„¡åˆ¶é™ï¼ˆå…¨é‡£æœã‚«ã‚¦ãƒ³ãƒˆï¼‰"},{value:1,label:"ãƒªãƒŸãƒƒãƒˆ1åŒ¹"},{value:2,label:"ãƒªãƒŸãƒƒãƒˆ2åŒ¹"},{value:3,label:"ãƒªãƒŸãƒƒãƒˆ3åŒ¹"},{value:4,label:"ãƒªãƒŸãƒƒãƒˆ4åŒ¹"},{value:5,label:"ãƒªãƒŸãƒƒãƒˆ5åŒ¹"},{value:10,label:"ãƒªãƒŸãƒƒãƒˆ10åŒ¹"}].find(n=>n.value===x);e&&(document.getElementById("selected-limit-text").textContent=e.label,document.getElementById("selected-limit-display").style.display="block",document.getElementById("limit-select-btn").textContent="ãƒªãƒŸãƒƒãƒˆåŒ¹æ•°ã‚’å¤‰æ›´"),updateSortOptions(),document.getElementById("sort1").value=a.sort1||"",document.getElementById("sort2").value=a.sort2||"",document.getElementById("sort3").value=a.sort3||"",updateSortOptions(),console.log("âœ… å¤§ä¼šè¨­å®šèª­ã¿è¾¼ã¿å®Œäº†:",a)}window.updateTournamentSettings=async function(){if(w!==2){c("ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™",!0);return}const t=document.getElementById("rule-type").value,e=x!==null?x:a.limit_count||0,n=document.getElementById("sort1").value,l=document.getElementById("sort2").value,o=document.getElementById("sort3").value,s=[n,l,o].filter(I=>I!==""),r=new Set(s);if(s.length!==r.size){c("åˆ¤å®šé †ä½ã§åŒã˜é …ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™",!0);return}console.log("ğŸ’¾ è¨­å®šä¿å­˜:",{ruleType:t,limitCount:e,sort1:n,sort2:l,sort3:o}),console.log("ğŸ’¾ æ›´æ–°æ¡ä»¶:",{id:g}),console.log("ğŸ’¾ æ›´æ–°å‰ã®CONFIG.limit_count:",a.limit_count);const{data:d,error:u}=await k.from("tournaments").update({rule_type:t,limit_count:e,sort1:n||null,sort2:l||null,sort3:o||null}).eq("id",g).select();if(console.log("ğŸ’¾ UPDATEçµæœ - data:",d),console.log("ğŸ’¾ UPDATEçµæœ - error:",u),u){console.error("âŒ è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:",u),console.error("âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°:",JSON.stringify(u,null,2)),console.error("âŒ ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:",u.code),console.error("âŒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:",u.message),alert(`âŒ è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼: ${u.message}
ã‚³ãƒ¼ãƒ‰: ${u.code}

âš ï¸ Supabase RLS UPDATEæ¨©é™ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
CRITICAL_FIX.sqlã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚`),c(`âŒ è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${u.message||u.code||"ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}`,!0);return}if(!d||d.length===0){console.error("âŒ æ›´æ–°å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"),c("âŒ æ›´æ–°å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ",!0);return}console.log("âœ… æ›´æ–°å¾Œã®ãƒ‡ãƒ¼ã‚¿:",d);const{data:b,error:E}=await k.from("tournaments").select("*").eq("id",g).single();if(E||!b){console.error("âŒ è¨­å®šå†å–å¾—ã‚¨ãƒ©ãƒ¼:",E),c("âŒ è¨­å®šã®å†å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ",!0);return}a=b,console.log("âœ… å†å–å¾—å¾Œã®CONFIG:",a),c("âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");const i=a.limit_count>0?`ãƒªãƒŸãƒƒãƒˆ${a.limit_count}åŒ¹`:"ç„¡åˆ¶é™",m=T[a.rule_type]||a.rule_type;document.getElementById("tournament-info").textContent=`${m} / ${i}`,await $(),console.log("âœ… è¨­å®šä¿å­˜å®Œäº†")};function c(t,e=!1){const n=document.getElementById("toast");n.textContent=t,n.className="toast"+(e?" error":""),n.style.display="block",setTimeout(()=>{n.style.display="none"},3e3)}let _=null,x=0;window.openPlayerDrumPicker=function(){const t=document.getElementById("player-drum-picker"),e=document.getElementById("player-select-btn");t.style.display==="none"||t.style.display===""?(t.style.display="block",e.textContent="é¸æŠã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«",e.classList.remove("btn-primary"),e.classList.add("btn-danger"),V()):(t.style.display="none",e.textContent="é¸æ‰‹ã‚’é¸æŠ",e.classList.remove("btn-danger"),e.classList.add("btn-primary"))};function V(){const t=document.getElementById("player-drum-list");if(f.length===0){t.innerHTML='<div class="drum-picker-item">é¸æ‰‹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';return}const e=[...f].sort((l,o)=>l.zekken-o.zekken);t.innerHTML=e.map(l=>`<div class="drum-picker-item" data-zekken="${l.zekken}">${l.zekken}ç•ª: ${l.name}</div>`).join(""),A("player-drum-picker",l=>{_=parseInt(l.getAttribute("data-zekken")),G()});const n=_?e.findIndex(l=>l.zekken===_):0;N("player-drum-picker",Math.max(0,n))}window.openLimitDrumPicker=function(){const t=document.getElementById("limit-drum-picker"),e=document.getElementById("limit-select-btn");t.style.display==="none"||t.style.display===""?(t.style.display="block",e.textContent="é¸æŠã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«",e.classList.remove("btn-primary"),e.classList.add("btn-danger"),J()):(t.style.display="none",e.textContent="ãƒªãƒŸãƒƒãƒˆåŒ¹æ•°ã‚’é¸æŠ",e.classList.remove("btn-danger"),e.classList.add("btn-primary"))};function J(){const t=document.getElementById("limit-drum-list"),e=[{value:0,label:"ç„¡åˆ¶é™ï¼ˆå…¨é‡£æœã‚«ã‚¦ãƒ³ãƒˆï¼‰"},{value:1,label:"ãƒªãƒŸãƒƒãƒˆ1åŒ¹"},{value:2,label:"ãƒªãƒŸãƒƒãƒˆ2åŒ¹"},{value:3,label:"ãƒªãƒŸãƒƒãƒˆ3åŒ¹"},{value:4,label:"ãƒªãƒŸãƒƒãƒˆ4åŒ¹"},{value:5,label:"ãƒªãƒŸãƒƒãƒˆ5åŒ¹"},{value:10,label:"ãƒªãƒŸãƒƒãƒˆ10åŒ¹"}];t.innerHTML=e.map(o=>`<div class="drum-picker-item" data-value="${o.value}">${o.label}</div>`).join(""),A("limit-drum-picker",o=>{x=parseInt(o.getAttribute("data-value")),Z()});const n=a.limit_count||0,l=e.findIndex(o=>o.value===n);N("limit-drum-picker",Math.max(0,l))}function A(t,e){const n=document.getElementById(t),l=n.querySelector(".drum-picker-list"),o=l.querySelectorAll(".drum-picker-item");let s=0,r=0,d=!1,u=0,b=0,E=Date.now();const i=y=>{d=!0;const h=y.type==="touchstart"?y.touches[0].clientY:y.clientY;s=h-r,u=0,b=h,E=Date.now(),l.style.transition="none"},m=y=>{if(!d)return;y.preventDefault();const h=y.type==="touchmove"?y.touches[0].clientY:y.clientY,B=Date.now(),p=B-E;p>0&&(u=(h-b)/p),b=h,E=B,r=h-s;const v=(o.length-1)*40;r=Math.max(-v,Math.min(0,r)),l.style.transform=`translateY(${r}px)`,O(t)},I=()=>{if(!d)return;d=!1,Math.abs(u)>.1&&(r+=u*100);const y=Math.round(-r/40),h=o.length-1;r=-Math.max(0,Math.min(h,y))*40,l.style.transition="transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)",l.style.transform=`translateY(${r}px)`,setTimeout(()=>{O(t);const p=l.querySelector(".drum-picker-item.active");p&&e&&e(p)},300)};n.addEventListener("touchstart",i,{passive:!1}),n.addEventListener("touchmove",m,{passive:!1}),n.addEventListener("touchend",I),n.addEventListener("mousedown",i),n.addEventListener("mousemove",m),n.addEventListener("mouseup",I),n.addEventListener("mouseleave",I)}function N(t,e){const l=document.getElementById(t).querySelector(".drum-picker-list"),o=-e*40;l.style.transition="transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)",l.style.transform=`translateY(${o}px)`,setTimeout(()=>O(t),300)}function O(t){const n=document.getElementById(t).querySelector(".drum-picker-list"),l=n.querySelectorAll(".drum-picker-item"),o=n.style.transform,s=o?parseFloat(o.match(/translateY\(([^)]+)\)/)?.[1]||0):0,r=Math.round(-s/40);l.forEach((d,u)=>{d.classList.toggle("active",u===r)})}function G(){const t=document.getElementById("player-drum-picker"),e=t.querySelector(".drum-picker-button-group");e&&e.remove();const n=document.createElement("div");n.className="drum-picker-button-group",n.innerHTML=`
        <button class="btn btn-danger" onclick="cancelPlayerSelection()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-success" onclick="confirmPlayerSelection()">æ±ºå®š</button>
    `,t.appendChild(n)}function Z(){const t=document.getElementById("limit-drum-picker"),e=t.querySelector(".drum-picker-button-group");e&&e.remove();const n=document.createElement("div");n.className="drum-picker-button-group",n.innerHTML=`
        <button class="btn btn-danger" onclick="cancelLimitSelection()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-success" onclick="confirmLimitSelection()">æ±ºå®š</button>
    `,t.appendChild(n)}window.confirmPlayerSelection=function(){if(_===null){c("é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„",!0);return}const t=f.find(n=>n.zekken===_);if(!t){c("é¸æ‰‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“",!0);return}document.getElementById("selected-player-text").textContent=`${t.zekken}ç•ª: ${t.name}`,document.getElementById("selected-player-display").style.display="block",document.getElementById("player-drum-picker").style.display="none";const e=document.getElementById("player-select-btn");e.textContent="é¸æ‰‹ã‚’å¤‰æ›´",e.classList.remove("btn-danger"),e.classList.add("btn-primary"),c(`âœ… ${t.name}ã‚’é¸æŠã—ã¾ã—ãŸ`)};window.cancelPlayerSelection=function(){openPlayerDrumPicker()};window.confirmLimitSelection=function(){const e=[{value:0,label:"ç„¡åˆ¶é™ï¼ˆå…¨é‡£æœã‚«ã‚¦ãƒ³ãƒˆï¼‰"},{value:1,label:"ãƒªãƒŸãƒƒãƒˆ1åŒ¹"},{value:2,label:"ãƒªãƒŸãƒƒãƒˆ2åŒ¹"},{value:3,label:"ãƒªãƒŸãƒƒãƒˆ3åŒ¹"},{value:4,label:"ãƒªãƒŸãƒƒãƒˆ4åŒ¹"},{value:5,label:"ãƒªãƒŸãƒƒãƒˆ5åŒ¹"},{value:10,label:"ãƒªãƒŸãƒƒãƒˆ10åŒ¹"}].find(l=>l.value===x);if(!e){c("ãƒªãƒŸãƒƒãƒˆåŒ¹æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„",!0);return}document.getElementById("selected-limit-text").textContent=e.label,document.getElementById("selected-limit-display").style.display="block",document.getElementById("limit-drum-picker").style.display="none";const n=document.getElementById("limit-select-btn");n.textContent="ãƒªãƒŸãƒƒãƒˆåŒ¹æ•°ã‚’å¤‰æ›´",n.classList.remove("btn-danger"),n.classList.add("btn-primary"),c(`âœ… ${e.label}ã‚’é¸æŠã—ã¾ã—ãŸ`)};window.cancelLimitSelection=function(){openLimitDrumPicker()};console.log("âœ… ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†");
